<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุฑุนุงูุฉ ุงูุฐูุจูุฉ - ุฃุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter for general text, Cairo for Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif; /* ุฎุท ุงููุงูุฑุฉ ุงูููุถู ููุนุฑุจูุฉ */
            background-color: #FDFBF7; /* ุฎูููุฉ ุจูุถุงุก ูุฑูููุฉ ูุงุนูุฉ */
        }
        .inter-font {
            font-family: 'Inter', sans-serif; /* ููุบุฉ ุงูุฅูุฌููุฒูุฉ ุฃู ุงูุฃุฑูุงู */
        }
        /* ุฏุฑุฌุงุช ุงูุฃููุงู ุงูุฐูุจูุฉ ุงููุงุฏุฆุฉ ูุงููุงุนูุฉ */
        .bg-gradient-header {
            background-image: linear-gradient(to right, #C59D5B, #DAA520); /* ุฐูุจู ุจุฑููุฒู ูุฐูุจู ุฃูุซุฑ ูุถูุญูุง */
        }
        .text-golden-main {
            color: #DAA520; /* ููู ุฐูุจู ูุชูุณุท */
        }
        .text-golden-dark {
            color: #C59D5B; /* ููู ุฐูุจู ุจุฑููุฒู ุฏุงูู */
        }
        .bg-golden-button {
            background-color: #DAA520; /* ููู ุฐูุจู ููุฃุฒุฑุงุฑ */
        }
        .hover\:bg-golden-dark:hover {
            background-color: #C59D5B; /* ููู ุฐูุจู ุจุฑููุฒู ุฏุงูู ุนูุฏ ุงูุชูุฑูุฑ */
        }
        .border-golden {
            border-color: #DAA520;
        }
        .bg-light-cream-gold {
            background-color: #EEDBB6; /* ููู ุฐูุจู ูุงุชุญ ูุฑููู ููุฎูููุงุช */
        }
        /* Custom scrollbar for a nicer look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #C59D5B; /* ููู ุฐูุจู ูุงุฏุฆ */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #DAA520; /* ููู ุฐูุจู ุฃุบูู ุนูุฏ ุงูุชูุฑูุฑ */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #DAA520;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header Section - Navigation Bar -->
    <header class="bg-gradient-header text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center space-x-3 rtl:space-x-reverse mb-3 md:mb-0">
                <img src="ุงูุฑุนุงูุฉ ุงูุฐูุจูุฉ 1.jpg" onerror="this.onerror=null;this.src='https://placehold.co/64x64/DAA520/ffffff?text=Logo';" alt="Golden Care Logo" class="w-16 h-16 object-cover rounded-full border-2 border-white shadow-md">
                <h1 class="text-3xl font-extrabold tracking-wide">ุงูุฑุนุงูุฉ ุงูุฐูุจูุฉ</h1>
            </div>
            <nav>
                <ul class="flex flex-wrap justify-center md:space-x-6 rtl:space-x-reverse space-x-3 text-lg font-medium">
                    <li><a href="index.html" class="hover:text-amber-200 transition duration-300">ุงูุฑุฆูุณูุฉ</a></li>
                    <li><a href="about.html" class="hover:text-amber-200 transition duration-300">ูู ูุญู</a></li>
                    <li><a href="services.html" class="hover:text-amber-200 transition duration-300">ุฎุฏูุงุชูุง</a></li>
                    <li><a href="team.html" class="hover:text-amber-200 transition duration-300">ูุฑูููุง</a></li>
                    <li><a href="history.html" class="hover:text-amber-200 transition duration-300">ุชุงุฑูุฎูุง</a></li>
                    <li><a href="jobs.html" class="hover:text-amber-200 transition duration-300">ูุธุงุฆู</a></li>
                    <li><a href="privacy.html" class="hover:text-amber-200 transition duration-300">ุงูุฎุตูุตูุฉ</a></li>
                    <li><a href="contact.html" class="hover:text-amber-200 transition duration-300">ุงุชุตู ุจูุง</a></li>
                    <li><a href="ai_tools.html" class="hover:text-amber-200 transition duration-300">ุฃุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Page Content - AI Tools -->
    <main class="py-16 bg-light-cream-gold px-6 min-h-screen">
        <div class="container mx-auto max-w-4xl bg-white p-8 rounded-xl shadow-lg border border-golden">
            <h2 class="text-5xl font-extrabold text-golden-dark text-center mb-12">
                ุฃุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุชูุฏูุฉ ๐ค
            </h2>
            <p class="text-lg leading-relaxed text-gray-700 mb-8 text-center">
                ุงูุชุดู ููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชูููุฏ ุตูุฑ ูุฑูุฏุฉ ูุชุญููู ุงููุตูุต ุฅูู ููุงู ูุณููุน ุจุฌูุฏุฉ ุนุงููุฉ.
            </p>

            <!-- Image Generation Section -->
            <section class="mb-12 p-6 bg-light-cream-gold rounded-lg shadow-md border-b-4 border-golden">
                <h3 class="text-4xl font-bold text-golden-dark mb-6 text-right">
                    ุชูููุฏ ุงูุตูุฑ ูู ุงููุต ๐ผ๏ธ
                </h3>
                <p class="text-md leading-relaxed text-gray-700 mb-6 text-right">
                    ุฃุฏุฎู ูุตููุง ุชูุตููููุง ููุตูุฑุฉ ุงูุชู ุชุฑุบุจ ูู ุฅูุดุงุฆูุงุ ูุณูููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจุชุญููู ูููุงุชู ุฅูู ุชุญูุฉ ุจุตุฑูุฉ.
                </p>
                <div class="mb-4">
                    <label for="imagePrompt" class="block text-gray-700 text-lg font-bold mb-2">ูุตู ุงูุตูุฑุฉ:</label>
                    <textarea id="imagePrompt" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-golden-main" rows="4" placeholder="ูุซุงู: ูุทุฉ ูุทููุฉ ุชุฑุชุฏู ูุจุนุฉ ุตุบูุฑุฉ ูุชุฌูุณ ุนูู ุฃุฑุฌูุญุฉ ูู ุญุฏููุฉ ุฎุถุฑุงุก ูุดุฑูุฉ."></textarea>
                </div>
                <button id="generateImageBtn" class="bg-golden-button hover:bg-golden-dark text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition duration-300 flex items-center justify-center">
                    ุชูููุฏ ุงูุตูุฑุฉ <i class="fas fa-magic mr-2 rtl:ml-2 rtl:mr-0"></i>
                    <span id="imageSpinner" class="spinner hidden mr-2 rtl:ml-2 rtl:mr-0"></span>
                </button>
                <div id="imageResult" class="mt-8 text-center bg-white p-4 rounded-lg shadow-inner">
                    <!-- ุงูุตูุฑุฉ ุงููุงุชุฌุฉ ุณุชุธูุฑ ููุง -->
                    <p id="imageMessage" class="text-gray-500">ุณูุชู ุนุฑุถ ุงูุตูุฑุฉ ุงููููุฏุฉ ููุง.</p>
                </div>
            </section>

            <!-- Text-to-Speech Section -->
            <section class="mb-12 p-6 bg-light-cream-gold rounded-lg shadow-md border-b-4 border-golden">
                <h3 class="text-4xl font-bold text-golden-dark mb-6 text-right">
                    ุชุญููู ุงููุชุงุจุฉ ุฅูู ุตูุช ๐
                </h3>
                <p class="text-md leading-relaxed text-gray-700 mb-6 text-right">
                    ุงูุชุจ ุฃู ูุต ุชุฑุบุจ ูู ุชุญูููู ุฅูู ููุงู ูุณููุน. ููููู ุงุฎุชูุงุฑ ูุจุฑุฉ ุงูุตูุช ุฃู ููุฌุชู.
                </p>
                <div class="mb-4">
                    <label for="ttsText" class="block text-gray-700 text-lg font-bold mb-2">ุงููุต ููุตูุช:</label>
                    <textarea id="ttsText" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-golden-main" rows="4" placeholder="ูุซุงู: ุฃููุงู ุจู ูู ุงูุฑุนุงูุฉ ุงูุฐูุจูุฉุ ุญูุซ ููุฏู ูู ุฃูุถู ุงูุฎุฏูุงุช."></textarea>
                </div>
                <div class="mb-6">
                    <label for="voiceSelect" class="block text-gray-700 text-lg font-bold mb-2">ุงุฎุชุฑ ุงูุตูุช (ุงููุจุฑุฉ/ุงูููุฌุฉ):</label>
                    <select id="voiceSelect" class="block w-full bg-white border border-gray-300 text-gray-700 py-3 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-golden-main">
                        <option value="Kore">ููุฑู (Kore) - ูุจุฑุฉ ุซุงุจุชุฉ</option>
                        <option value="Puck">ุจุงู (Puck) - ูุจุฑุฉ ูุฑุญุฉ</option>
                        <option value="Zephyr">ุฒููุฑ (Zephyr) - ูุจุฑุฉ ูุดุฑูุฉ</option>
                        <option value="Charon">ุดุงุฑูู (Charon) - ูุจุฑุฉ ุฅุฎุจุงุฑูุฉ</option>
                        <option value="Fenrir">ููุฑูุฑ (Fenrir) - ูุจุฑุฉ ุญูุงุณูุฉ</option>
                        <option value="Leda">ููุฏุง (Leda) - ูุจุฑุฉ ุดุงุจุฉ</option>
                        <option value="Orus">ุฃูุฑูุณ (Orus) - ูุจุฑุฉ ุญุงุฒูุฉ</option>
                        <option value="Aoede">ุฃููุฏ (Aoede) - ูุจุฑุฉ ุณูุณุฉ</option>
                        <option value="Callirrhoe">ูุงููุฑูู (Callirrhoe) - ูุจุฑุฉ ุณููุฉ</option>
                        <option value="Autonoe">ุฃูุชูููู (Autonoe) - ูุจุฑุฉ ูุดุฑูุฉ</option>
                        <option value="Enceladus">ุฅูุณููุงุฏูุณ (Enceladus) - ูุจุฑุฉ ุชููุณูุฉ</option>
                        <option value="Iapetus">ุฅูุงุจูุชูุณ (Iapetus) - ูุจุฑุฉ ูุงุถุญุฉ</option>
                        <option value="Umbriel">ุฃููุจุฑูู (Umbriel) - ูุจุฑุฉ ุณููุฉ</option>
                        <option value="Algieba">ุฃูุฌูุจุง (Algieba) - ูุจุฑุฉ ุณูุณุฉ</option>
                        <option value="Despina">ุฏูุณุจููุง (Despina) - ูุจุฑุฉ ุณูุณุฉ</option>
                        <option value="Erinome">ุฅุฑูููู (Erinome) - ูุจุฑุฉ ูุงุถุญุฉ</option>
                        <option value="Algenib">ุฃูุฌููุจ (Algenib) - ูุจุฑุฉ ุฎุดูุฉ</option>
                        <option value="Rasalgethi">ุฑุงุณุงูุฌูุซู (Rasalgethi) - ูุจุฑุฉ ุฅุฎุจุงุฑูุฉ</option>
                        <option value="Laomedeia">ูุงูููุฏูุง (Laomedeia) - ูุจุฑุฉ ูุฑุญุฉ</option>
                        <option value="Achernar">ุฃุฎูุฑูุงุฑ (Achernar) - ูุจุฑุฉ ูุงุนูุฉ</option>
                        <option value="Alnilam">ุฃููููุงู (Alnilam) - ูุจุฑุฉ ุซุงุจุชุฉ</option>
                        <option value="Schedar">ุดูุฏุงุฑ (Schedar) - ูุจุฑุฉ ูุชูุงุฒูุฉ</option>
                        <option value="Gacrux">ุฌุงูุฑููุณ (Gacrux) - ูุจุฑุฉ ูุงุถุฌุฉ</option>
                        <option value="Pulcherrima">ุจููุดูุฑููุง (Pulcherrima) - ูุจุฑุฉ ุฌุฑูุฆุฉ</option>
                        <option value="Achird">ุฃุดูุฑุฏ (Achird) - ูุจุฑุฉ ูุฏูุฏุฉ</option>
                        <option value="Zubenelgenubi">ุฒูุจูููุฌููุจู (Zubenelgenubi) - ูุจุฑุฉ ุนุงุฏูุฉ</option>
                        <option value="Vindemiatrix">ูููุฏููุงุชุฑููุณ (Vindemiatrix) - ูุจุฑุฉ ูุทููุฉ</option>
                        <option value="Sadachbia">ุณุงุฏุงุดุจูุง (Sadachbia) - ูุจุฑุฉ ุญูููุฉ</option>
                        <option value="Sadaltager">ุณุงุฏุงูุชุงุฌูุฑ (Sadaltager) - ูุจุฑุฉ ูุนุฑููุฉ</option>
                        <option value="Sulafat">ุณููุงูุงุช (Sulafat) - ูุจุฑุฉ ุฏุงูุฆุฉ</option>
                    </select>
                </div>
                <button id="generateTtsBtn" class="bg-golden-button hover:bg-golden-dark text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition duration-300 flex items-center justify-center">
                    ุชุญููู ุฅูู ุตูุช <i class="fas fa-play-circle mr-2 rtl:ml-2 rtl:mr-0"></i>
                    <span id="ttsSpinner" class="spinner hidden mr-2 rtl:ml-2 rtl:mr-0"></span>
                </button>
                <div id="ttsResult" class="mt-8 text-center bg-white p-4 rounded-lg shadow-inner">
                    <!-- ูุดุบู ุงูุตูุช ุณูุธูุฑ ููุง -->
                    <p id="ttsMessage" class="text-gray-500">ุณูุชู ุชุดุบูู ุงูุตูุช ููุง.</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-900 text-gray-300 py-8 px-6">
        <div class="container mx-auto text-center">
            <p class="mb-4">&copy; 2025 ุงูุฑุนุงูุฉ ุงูุฐูุจูุฉ. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
            <div class="flex justify-center space-x-6 rtl:space-x-reverse">
                <a href="#" class="hover:text-golden-main transition duration-300"><i class="fab fa-facebook-f text-xl"></i></a>
                <a href="#" class="hover:text-golden-main transition duration-300"><i class="fab fa-twitter text-xl"></i></a>
                <a href="#" class="hover:text-golden-main transition duration-300"><i class="fab fa-linkedin-in text-xl"></i></a>
                <a href="#" class="hover:text-golden-main transition duration-300"><i class="fab fa-instagram text-xl"></i></a>
            </div>
            <p class="mt-4 text-sm opacity-75">
                ุชุตููู ูุชุทููุฑ ุจูุงุณุทุฉ ูุฑูู ุงูุฑุนุงูุฉ ุงูุฐูุจูุฉ
            </p>
        </div>
    </footer>

    <script>
        // ุฏุงูุฉ ูุชุญููู Base64 ุฅูู ArrayBuffer (ูุชุญููู PCM ุฅูู WAV)
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // ุฏุงูุฉ ูุชุญููู PCM ุฅูู WAV
        function pcmToWav(pcm16Data, sampleRate) {
            const pcmData = pcm16Data.buffer;
            const numChannels = 1; // PCM is typically mono
            const bytesPerSample = 2; // 16-bit PCM

            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF'); // ChunkID
            view.setUint32(4, 36 + pcmData.byteLength, true); // ChunkSize
            writeString(view, 8, 'WAVE'); // Format

            // FMT sub-chunk
            writeString(view, 12, 'fmt '); // Subchunk1ID
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true); // NumChannels
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // ByteRate
            view.setUint16(32, numChannels * bytesPerSample, true); // BlockAlign
            view.setUint16(34, bytesPerSample * 8, true); // BitsPerSample

            // DATA sub-chunk
            writeString(view, 36, 'data'); // Subchunk2ID
            view.setUint32(40, pcmData.byteLength, true); // Subchunk2Size

            const blob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
            return blob;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // --- Image Generation Logic ---
        const generateImageBtn = document.getElementById('generateImageBtn');
        const imagePromptInput = document.getElementById('imagePrompt');
        const imageResultDiv = document.getElementById('imageResult');
        const imageMessageP = document.getElementById('imageMessage');
        const imageSpinner = document.getElementById('imageSpinner');

        generateImageBtn.addEventListener('click', async () => {
            const prompt = imagePromptInput.value.trim();
            if (!prompt) {
                imageMessageP.textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุตู ููุตูุฑุฉ.';
                imageMessageP.classList.remove('text-gray-500', 'text-green-600', 'text-red-600');
                imageMessageP.classList.add('text-red-600');
                return;
            }

            // Show loading spinner and clear previous results
            imageSpinner.classList.remove('hidden');
            generateImageBtn.disabled = true;
            imageResultDiv.innerHTML = `<p id="imageMessage" class="text-gray-500">ุฌุงุฑู ุชูููุฏ ุงูุตูุฑุฉุ ูุฏ ูุณุชุบุฑู ุงูุฃูุฑ ุจุนุถ ุงูููุช...</p>`;

            // Exponential backoff retry mechanism
            let retries = 0;
            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const payload = {
                        instances: { prompt: prompt },
                        parameters: { "sampleCount": 1 }
                    };
                    // The apiKey is automatically provided by Canvas when it's an empty string.
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        imageResultDiv.innerHTML = `<img src="${imageUrl}" alt="Generated Image" class="w-full h-auto rounded-lg shadow-md mx-auto max-w-sm" onerror="this.onerror=null;this.src='https://placehold.co/400x300/C59D5B/ffffff?text=Image+Error';" />`;
                        imageMessageP.textContent = ''; // Clear message
                        break; // Exit retry loop on success
                    } else {
                        imageResultDiv.innerHTML = `<p id="imageMessage" class="text-red-600">ูุดู ูู ุชูููุฏ ุงูุตูุฑุฉ: ${result.error?.message || 'ุงุณุชุฌุงุจุฉ ุบูุฑ ูุชููุนุฉ.'}</p>`;
                        console.error('Image generation error:', result);
                        // If it's a transient error, retry
                        if (response.status >= 500 || response.status === 429) { // 5xx for server errors, 429 for too many requests
                            retries++;
                            const delay = baseDelay * Math.pow(2, retries);
                            await new Promise(res => setTimeout(res, delay));
                        } else {
                            break; // Do not retry for client errors
                        }
                    }
                } catch (error) {
                    console.error('Fetch error during image generation:', error);
                    imageResultDiv.innerHTML = `<p id="imageMessage" class="text-red-600">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู: ${error.message}.</p>`;
                    retries++;
                    const delay = baseDelay * Math.pow(2, retries);
                    await new Promise(res => setTimeout(res, delay));
                }
            }

            if (retries === maxRetries) {
                imageResultDiv.innerHTML = `<p id="imageMessage" class="text-red-600">ูุดู ุชูููุฏ ุงูุตูุฑุฉ ุจุนุฏ ุนุฏุฉ ูุญุงููุงุช. ูุฑุฌู ุงููุญุงููุฉ ูุงุญููุง.</p>`;
            }

            imageSpinner.classList.add('hidden');
            generateImageBtn.disabled = false;
        });

        // --- Text-to-Speech Logic ---
        const generateTtsBtn = document.getElementById('generateTtsBtn');
        const ttsTextInput = document.getElementById('ttsText');
        const voiceSelect = document.getElementById('voiceSelect');
        const ttsResultDiv = document.getElementById('ttsResult');
        const ttsMessageP = document.getElementById('ttsMessage');
        const ttsSpinner = document.getElementById('ttsSpinner');

        generateTtsBtn.addEventListener('click', async () => {
            const text = ttsTextInput.value.trim();
            const selectedVoice = voiceSelect.value;
            if (!text) {
                ttsMessageP.textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุต ูุชุญูููู ุฅูู ุตูุช.';
                ttsMessageP.classList.remove('text-gray-500', 'text-green-600', 'text-red-600');
                ttsMessageP.classList.add('text-red-600');
                return;
            }

            // Show loading spinner and clear previous results
            ttsSpinner.classList.remove('hidden');
            generateTtsBtn.disabled = true;
            ttsResultDiv.innerHTML = `<p id="ttsMessage" class="text-gray-500">ุฌุงุฑู ุชุญููู ุงููุต ุฅูู ุตูุชุ ูุฑุฌู ุงูุงูุชุธุงุฑ...</p>`;

            let retries = 0;
            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: text }]
                        }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: selectedVoice }
                                }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };

                    const apiKey = ""; // Canvas provides this automatically
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        // Extract sample rate from mimeType if available, default to 16000
                        const match = mimeType.match(/rate=(\d+)/);
                        const sampleRate = match ? parseInt(match[1], 10) : 16000;

                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData); // PCM 16-bit signed

                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);

                        ttsResultDiv.innerHTML = `<audio controls src="${audioUrl}" class="w-full mt-4"></audio>`;
                        ttsMessageP.textContent = 'ุชู ุชุญููู ุงููุต ุฅูู ุตูุช ุจูุฌุงุญ.';
                        ttsMessageP.classList.remove('text-gray-500', 'text-red-600');
                        ttsMessageP.classList.add('text-green-600');
                        break; // Exit retry loop on success
                    } else {
                        ttsResultDiv.innerHTML = `<p id="ttsMessage" class="text-red-600">ูุดู ูู ุชุญููู ุงููุต ุฅูู ุตูุช: ${result.error?.message || 'ุงุณุชุฌุงุจุฉ ุบูุฑ ูุชููุนุฉ ุฃู ุชูุณูู ุบูุฑ ูุฏุนูู.'}</p>`;
                        console.error('TTS error:', result);
                        // If it's a transient error, retry
                        if (response.status >= 500 || response.status === 429) {
                            retries++;
                            const delay = baseDelay * Math.pow(2, retries);
                            await new Promise(res => setTimeout(res, delay));
                        } else {
                            break; // Do not retry for client errors
                        }
                    }
                } catch (error) {
                    console.error('Fetch error during TTS:', error);
                    ttsResultDiv.innerHTML = `<p id="ttsMessage" class="text-red-600">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู: ${error.message}.</p>`;
                    retries++;
                    const delay = baseDelay * Math.pow(2, retries);
                    await new Promise(res => setTimeout(res, delay));
                }
            }

            if (retries === maxRetries) {
                ttsResultDiv.innerHTML = `<p id="ttsMessage" class="text-red-600">ูุดู ุชุญููู ุงููุต ุฅูู ุตูุช ุจุนุฏ ุนุฏุฉ ูุญุงููุงุช. ูุฑุฌู ุงููุญุงููุฉ ูุงุญููุง.</p>`;
            }

            ttsSpinner.classList.add('hidden');
            generateTtsBtn.disabled = false;
        });

    </script>
</body>
</html>
